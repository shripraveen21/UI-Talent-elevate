<!-- Back Button and Page Title (only show when not in test mode) -->
<div *ngIf="!showStartModal && !showFullscreenModal && !isTestStarted" class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
  <div class="flex items-center justify-between mb-6">
    <app-backbutton
      [label]="'Return to Dashboard'"
      [icon]="true"
      [clickHandler]="returnToDashboard.bind(this)">
    </app-backbutton>
    <div class="flex-1 text-center">
      <h1 class="text-3xl font-bold text-gray-900">Assessment Test</h1>
    </div>
  </div>
</div>

<!-- Start Test Modal (Full Screen Entry) -->
<div
  *ngIf="showStartModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80"
  style="backdrop-filter: blur(2px);"
>
  <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Start Test in Full Screen</h2>
    <p class="text-gray-700 mb-6">
      To begin your test, please click the button below.<br>
      The test will run in full screen mode and you must remain in full screen until submission.
    </p>
    <button
      type="button"
      (click)="startTestInFullscreen()"
      class="w-full px-6 py-3 bg-gradient-hero text-white font-bold rounded-lg hover:shadow-glow hover:-translate-y-1 hover:scale-105 transition-all duration-200 text-lg transform"
    >
      Start Test in Full Screen
    </button>
  </div>
</div>

<!-- Fullscreen Enforcement Modal -->
<div
  *ngIf="showFullscreenModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"
  style="backdrop-filter: blur(2px);"
>
  <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Full Screen Required</h2>
    <p class="text-gray-700 mb-6">
      You have exited full screen mode.<br>
      Please return to full screen to continue your test, or submit your test now.
    </p>
    <div class="flex flex-col space-y-4">
      <button
        type="button"
        (click)="goToFullScreen()"
        class="w-full px-6 py-3 bg-gradient-hero text-white font-bold rounded-lg hover:shadow-glow hover:-translate-y-1 hover:scale-105 transition-all duration-200 text-lg transform"
      >
        Go to Full Screen
      </button>
      <button
        type="button"
        (click)="submitTestFromModal()"
        class="w-full px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors text-lg"
      >
        Submit Test
      </button>
    </div>
  </div>
</div>

<!-- Already Attended Modal -->
<div
  *ngIf="showAlreadyAttendedModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"
  style="backdrop-filter: blur(2px);"
>
  <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Test Already Attended</h2>
    <p class="text-gray-700 mb-6">
      You have already attended this test.<br>
      You will be redirected to your dashboard.
    </p>
    <button
      type="button"
      (click)="continueToDashboard()"
      class="w-full px-6 py-3 bg-gradient-hero text-white font-bold rounded-lg hover:shadow-glow hover:-translate-y-1 hover:scale-105 transition-all duration-200 text-lg transform"
    >
      Continue
    </button>
  </div>
</div>
 

<div #testContainer class="container mx-auto px-6 py-8">
  <!-- Page Title -->
  <h1 class="text-3xl font-bold text-gray-800">{{testTitle}}</h1>
  <p class="mt-2 text-gray-600">Welcome back,{{showFullscreenModal}} {{currentUserName}}! Here's your test.</p>

  <!-- Loading State -->
  <div *ngIf="loading" class="mt-8 bg-white p-6 rounded-lg border border-gray-200">
    <div class="flex items-center justify-center">
      <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mr-4"></div>
      <p class="text-gray-600">Loading test...</p>
  </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="mt-8 bg-red-50 border border-red-200 rounded-lg p-6">
    <div class="flex items-start">
      <svg class="w-6 h-6 text-red-500 mt-1 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div>
        <h3 class="text-lg font-semibold text-red-800 mb-2">Error Details</h3>
        <p class="text-red-700 leading-relaxed">{{error}}</p>
      </div>
    </div>
  </div>

  <!-- Test Progress Section -->
  <div *ngIf="!loading && !error && testDetails" class="mt-8 bg-white p-6 rounded-lg border border-gray-200">
    <div class="flex justify-between items-center">
      <div>
        <h2 class="text-lg font-bold text-gray-800">{{testTitle}}</h2>
        <p class="text-sm text-gray-500">{{testDescription}}</p>
      </div>
      <div class="flex items-center space-x-2 text-sm font-medium text-gray-700" *ngIf="timeRemaining > 0">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
        </svg>
        <span [class.text-red-500]="timeRemaining < 60" [class.text-orange-500]="timeRemaining >= 60 && timeRemaining < 300">{{timeDisplay}}</span>
      </div>
    </div>
    <div class="mt-4">
      <div class="w-full bg-gray-200 rounded-full h-2.5">
        <div class="bg-gradient-hero h-2.5 rounded-full" [style.width.%]="getProgressPercentage()"></div>
      </div>
      <p class="text-sm text-gray-600 mt-2">Answered {{getAnsweredQuestionsCount()}} of {{testDetails.questions.length}} questions</p>
    </div>
  </div>

  <!-- Test Questions -->
  <div *ngIf="testDetails" class="mt-6 space-y-8">
    <form (ngSubmit)="submit()" class="space-y-8">
      <div *ngFor="let question of testDetails.questions; let i = index" class="question-card">
        <div class="mb-6">
          <h3 class="question-title">Question {{i + 1}}: {{ question.text }}</h3>
        </div>

        <div *ngIf="question.type === 'multiple_choice'" class="space-y-4">
          <div *ngFor="let option of question.options" class="option-container">
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300 transition-colors"
                   [class.border-green-500]="answers[question.id] === option.key"
                   [class.bg-green-50]="answers[question.id] === option.key"
                   [class.shadow-green-100]="answers[question.id] === option.key">
              <input
                type="radio"
                [attr.name]="question.id"
                [value]="option.key"
                [checked]="answers[question.id] === option.key"
                (change)="handleAnswer(question.id, option.key)"
                class="sr-only"
              >
              <div class="w-5 h-5 border-2 rounded-full mr-4 flex-shrink-0"
                   [class.border-gray-300]="answers[question.id] !== option.key"
                   [class.border-green-500]="answers[question.id] === option.key"
                   [class.bg-green-500]="answers[question.id] === option.key">
                <div *ngIf="answers[question.id] === option.key" class="w-full h-full flex items-center justify-center">
                  <div class="w-2 h-2 bg-white rounded-full"></div>
                </div>
              </div>
              <span class="text-gray-800 font-medium">{{ option.key }}: {{ option.value }}</span>
            </label>
          </div>
        </div>

        <div *ngIf="question.type === 'text'" class="mt-4">
          <input
            type="text"
            [attr.name]="question.id"
            #textInput
            [value]="answers[question.id] || ''"
            (input)="handleAnswer(question.id, textInput.value)"
            class="w-full p-4 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 text-lg transition-colors"
            [class.border-gray-200]="!answers[question.id]"
            [class.border-green-500]="answers[question.id]"
            [class.bg-green-50]="answers[question.id]"
            [class.focus:border-green-500]="answers[question.id]"
            placeholder="Enter your answer here..."
          >
        </div>
      </div>
    </form>

    <!-- Submit Button - Outside of form to avoid form submission issues -->
    <div class="mt-10 pt-6 border-t border-gray-200">
      <div class="flex items-center justify-end">
        <button
          type="button"
          (click)="submit()"
          [disabled]="submitted"
          class="px-10 py-3 bg-gradient-hero text-white font-bold rounded-lg hover:shadow-glow hover:-translate-y-1 hover:scale-105 transition-all duration-200 text-lg disabled:opacity-50 disabled:cursor-not-allowed transform"
        >
          <span *ngIf="!submitted">Submit Test</span>
          <span *ngIf="submitted" class="flex items-center">
            <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
            Submitting...
          </span>
        </button>
      </div>
    </div>
  </div>


</div>
