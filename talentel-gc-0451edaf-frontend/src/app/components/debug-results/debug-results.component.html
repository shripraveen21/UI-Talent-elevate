<!-- Main Content -->
<main class="container mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-10">
  <!-- Page Title -->
  <div>
    <h1 class="text-3xl font-bold text-gray-900">Debug Exercise Results</h1>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="mt-8 bg-white p-8 rounded-lg border border-gray-200">
    <div class="flex items-center justify-center py-8">
      <span class="text-blue-600 font-semibold text-lg animate-pulse">
        Wait till we generate your result and feedback...
      </span>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="mt-8 bg-white p-8 rounded-lg border border-gray-200">
    <div class="flex items-center justify-center py-8">
      <span class="text-red-500 font-semibold text-lg">{{ error }}</span>
    </div>
  </div>

  <!-- Processing State -->
  <div *ngIf="!loading && !result" class="mt-8 bg-white p-8 rounded-lg border border-gray-200">
    <div class="text-center py-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Thanks for submitting.</h2>
      <p class="text-gray-600">Your responses have been stored. You will get feedback soon.</p>
    </div>
  </div>

  <!-- Overall Performance Card -->
  <div *ngIf="!loading && result" class="mt-8 bg-white p-8 rounded-lg border border-gray-200">
    <a href="#" class="inline-flex items-center space-x-2 text-sm font-medium text-gray-500 hover:text-gray-700 mb-6">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      <span>Back to Dashboard</span>
    </a>

    <div>
      <h2 class="text-xl font-semibold text-gray-900">Debug Exercise Results</h2>
      <p class="mt-1 text-sm text-gray-500">Comprehensive analysis of your debugging skills</p>
    </div>
    
    <div class="mt-6 text-center border-b border-gray-200 pb-6">
      <p class="text-sm font-medium text-gray-500">Overall Performance</p>
      <p class="text-gray-400 text-xs">Your debugging assessment summary</p>
      <!-- Dynamic score color based on percentage -->
      <p class="text-6xl font-bold mt-2" 
         [class.text-red-600]="getOverallScore() < 60"
         [class.text-orange-500]="getOverallScore() >= 60 && getOverallScore() < 80"
         [class.text-green-600]="getOverallScore() >= 80">
        {{ getOverallScore() }}%
      </p>
      <p class="text-lg font-semibold text-gray-500">Grade: {{ getOverallGrade() }}</p>
    </div>

    <div class="grid grid-cols-3">
      <div class="py-4 text-center border-r border-gray-200">
        <p class="text-2xl font-bold text-green-600">{{ getCorrectCount() }}</p>
        <p class="text-sm text-gray-500">Correct</p>
      </div>
      <div class="py-4 text-center border-r border-gray-200">
        <p class="text-2xl font-bold text-yellow-500">{{ getPartialCount() }}</p>
        <p class="text-sm text-gray-500">Partial</p>
      </div>
      <div class="py-4 text-center">
        <p class="text-2xl font-bold text-red-600">{{ getIncorrectCount() }}</p>
        <p class="text-sm text-gray-500">Incorrect</p>
      </div>
    </div>
  </div>

  <!-- Exercise-by-Exercise Analysis Card -->
  <div *ngIf="!loading && result && result.results?.length > 0" class="mt-8 bg-white p-8 rounded-lg border border-gray-200">
    <div>
      <h2 class="text-xl font-semibold text-gray-900">Exercise-by-Exercise Analysis</h2>
      <p class="mt-1 text-sm text-gray-500">Detailed feedback for each debugging challenge</p>
    </div>

    <!-- Exercise Tabs -->
    <div class="mt-6">
      <div class="bg-gray-100 p-1.5 rounded-lg flex items-center justify-between">
        <button *ngFor="let res of result.results; let i = index" 
           (click)="selectExercise(i)" 
           class="text-sm font-semibold flex items-center justify-center space-x-2 flex-grow text-center py-2 px-4 rounded-md"
           [class.bg-white]="i === selectedExerciseIndex"
           [class.shadow-sm]="i === selectedExerciseIndex"
           [class.text-red-600]="i === selectedExerciseIndex && res.status === 'INCORRECT'"
           [class.text-green-600]="i === selectedExerciseIndex && res.status === 'CORRECT'"
           [class.text-gray-500]="i !== selectedExerciseIndex">
          <svg *ngIf="res.status === 'INCORRECT'" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
          <svg *ngIf="res.status === 'CORRECT'" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span>Exercise {{ i + 1 }}</span>
        </button>
      </div>
    </div>

    <!-- Exercise Details -->
    <div *ngFor="let res of result.results; let i = index" class="pt-6" [style.display]="i === selectedExerciseIndex ? 'block' : 'none'">
      <h3 class="text-lg font-semibold text-gray-900">{{ res.title }}</h3>
      <div class="flex items-center space-x-2 mt-2">
        <span class="text-xs font-medium bg-red-100 text-red-800 px-2.5 py-1 rounded-full">{{ res.score }}% - Grade {{ res.grade }}</span>
        <span class="text-xs font-medium bg-white border border-gray-300 text-gray-800 px-2.5 py-1 rounded-full">{{ res.status }}</span>
        <span class="text-xs font-medium bg-gray-800 text-white px-2.5 py-1 rounded-full">Confidence: {{ res.confidence }}</span>
      </div>

      <!-- Analysis Sections as separate cards -->
      <div class="mt-6 space-y-6">
        <!-- Score Breakdown -->
        <div class="p-6 border border-gray-200 rounded-lg">
          <h4 class="text-base font-semibold text-gray-800 mb-4">Score Breakdown</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Correctness</span>
                <span class="font-medium text-gray-800">{{ getCorrectnessScore(res) }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-red-600 h-2 rounded-full" [style.width.%]="getCorrectnessScore(res)"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Code Quality</span>
                <span class="font-medium text-gray-800">{{ getCodeQualityScore(res) }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-red-600 h-2 rounded-full" [style.width.%]="getCodeQualityScore(res)"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Completeness</span>
                <span class="font-medium text-gray-800">{{ getCompletenessScore(res) }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-red-600 h-2 rounded-full" [style.width.%]="getCompletenessScore(res)"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Learning Application</span>
                <span class="font-medium text-gray-800">{{ getLearningScore(res) }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-red-600 h-2 rounded-full" [style.width.%]="getLearningScore(res)"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Strengths -->
        <div *ngIf="getStrengths(res).length > 0" class="feedback-section">
          <div class="feedback-header">
            <svg class="feedback-icon text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
            <h4 class="feedback-title">Strengths</h4>
          </div>
          <div class="prose prose-sm max-w-none">
            <markdown [data]="getStrengthsMarkdown(res)"></markdown>
          </div>
        </div>

        <!-- Areas for Improvement -->
        <div *ngIf="getAreasForImprovement(res).length > 0" class="feedback-section">
          <div class="feedback-header">
            <svg class="feedback-icon text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
            </svg>
            <h4 class="feedback-title">Areas for Improvement</h4>
          </div>
          <div class="prose prose-sm max-w-none">
            <markdown [data]="getAreasForImprovementMarkdown(res)"></markdown>
          </div>
        </div>

        <!-- Next Steps -->
        <div *ngIf="getNextSteps(res).length > 0" class="feedback-section">
          <div class="feedback-header">
            <svg class="feedback-icon text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h4 class="feedback-title">Next Steps</h4>
          </div>
          <div class="prose prose-sm max-w-none">
            <markdown [data]="getNextStepsMarkdown(res)"></markdown>
          </div>
        </div>

        <!-- Learning Resources -->
        <div *ngIf="getResources(res).length > 0 || getResourcesMarkdown(res).trim()" class="feedback-section">
          <div class="feedback-header">
            <svg class="feedback-icon text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <h4 class="feedback-title">Learning Resources</h4>
          </div>
          
          <!-- Clickable Resource Links -->
          <div *ngIf="getResources(res).length > 0" class="space-y-3 mb-4">
            <div *ngFor="let resource of getResources(res)" class="flex justify-between items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" (click)="openResource(resource)">
              <span class="text-sm text-blue-600 font-medium hover:underline">{{ getResourceTitle(resource) }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </div>
          
          <!-- Markdown Content (headings, text, etc.) -->
          <div *ngIf="getResourcesMarkdown(res).trim()" class="prose prose-sm max-w-none">
            <markdown [data]="getResourcesMarkdown(res)"></markdown>
          </div>
        </div>

        <!-- Download Detailed Feedback Button -->
        <div *ngIf="res.validation" class="mt-8 text-center">
          <button 
            (click)="openPdfDownloadModal(res, i)"
            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-gradient-hero hover:shadow-glow hover:-translate-y-1 hover:scale-105 transition-all duration-200 transform focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-lg">
            <svg class="mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Download Detailed Feedback (PDF)
          </button>
        </div>

         <!-- Enhanced Validation & Assessment Section (Hidden) -->
         <div *ngIf="false" class="validation-section">
           <div class="validation-header">
             <svg class="validation-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
               <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
             </svg>
             <h4 class="validation-title">Validation & Assessment</h4>
           </div>
           
           <!-- Overall Assessment Summary -->
           <div class="assessment-section overall-assessment">
             <h3 class="section-heading">📊 Overall Assessment</h3>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
               <div class="assessment-card grade-card">
                 <div class="card-icon">🎯</div>
                 <h4 class="card-title">Overall Score</h4>
                 <div class="score-display" [style.color]="getScoreColor(res.score)">{{res.score}}%</div>
                 <p class="grade-display">Grade: {{res.grade}}</p>
               </div>
               <div class="assessment-card status-card">
                 <div class="card-icon">📊</div>
                 <h4 class="card-title">Status</h4>
                 <div class="status-display">
                   <span class="status-badge" [ngClass]="getStatusBadgeClass(res.score)">
                     {{getStatusText(res.score)}}
                   </span>
                 </div>
               </div>
             </div>
           </div>

           <!-- Structured Feedback Sections -->
           <div class="feedback-sections">
             <!-- Section 1: Correctness Assessment -->
             <div class="feedback-section correctness-section">
               <div class="feedback-header">
                 <span class="feedback-icon">{{getSectionIcon('correctness')}}</span>
                 <h3 class="feedback-title">1. Correctness Assessment</h3>
               </div>
               <div class="section-content" [innerHTML]="processCodeBlocks(getStructuredFeedback(res.validation, 'correctness'))"></div>
             </div>

             <!-- Section 2: Code Quality Analysis -->
             <div class="feedback-section code-quality-section">
               <div class="feedback-header">
                 <span class="feedback-icon">{{getSectionIcon('code-quality')}}</span>
                 <h3 class="feedback-title">2. Code Quality Analysis</h3>
               </div>
               <div class="section-content" [innerHTML]="processCodeBlocks(getStructuredFeedback(res.validation, 'code_quality'))"></div>
             </div>

             <!-- Section 3: Completeness Check -->
             <div class="feedback-section completeness-section">
               <div class="feedback-header">
                 <span class="feedback-icon">{{getSectionIcon('completeness')}}</span>
                 <h3 class="feedback-title">3. Completeness Check</h3>
               </div>
               <div class="section-content" [innerHTML]="processCodeBlocks(getStructuredFeedback(res.validation, 'completeness'))"></div>
             </div>

             <!-- Section 4: Alternative Solutions -->
             <div class="feedback-section alternatives-section">
               <div class="feedback-header">
                 <span class="feedback-icon">{{getSectionIcon('alternatives')}}</span>
                 <h3 class="feedback-title">4. Alternative Solutions</h3>
               </div>
               <div class="section-content" [innerHTML]="processCodeBlocks(getStructuredFeedback(res.validation, 'alternatives'))"></div>
             </div>

             <!-- Section 5: Specific Improvements -->
             <div class="feedback-section improvements-section">
               <div class="feedback-header">
                 <span class="feedback-icon">{{getSectionIcon('improvements')}}</span>
                 <h3 class="feedback-title">5. Specific Improvements Needed</h3>
               </div>
               <div class="section-content">
                 <ul class="feedback-list" *ngIf="formatBulletPoints(getStructuredFeedback(res.validation, 'improvements')).length > 0">
                   <li *ngFor="let point of formatBulletPoints(getStructuredFeedback(res.validation, 'improvements'))" [innerHTML]="processCodeBlocks(point)"></li>
                 </ul>
                 <div *ngIf="formatBulletPoints(getStructuredFeedback(res.validation, 'improvements')).length === 0" [innerHTML]="processCodeBlocks(getStructuredFeedback(res.validation, 'improvements'))"></div>
               </div>
             </div>

             <!-- Section 6: Code Quality Recommendations -->
             <div class="feedback-section recommendations-section">
               <div class="feedback-header">
                 <span class="feedback-icon">{{getSectionIcon('recommendations')}}</span>
                 <h3 class="feedback-title">6. Code Quality Recommendations</h3>
               </div>
               <div class="section-content">
                 <ul class="feedback-list" *ngIf="formatBulletPoints(getStructuredFeedback(res.validation, 'recommendations')).length > 0">
                   <li *ngFor="let point of formatBulletPoints(getStructuredFeedback(res.validation, 'recommendations'))" [innerHTML]="processCodeBlocks(point)"></li>
                 </ul>
                 <div *ngIf="formatBulletPoints(getStructuredFeedback(res.validation, 'recommendations')).length === 0" [innerHTML]="processCodeBlocks(getStructuredFeedback(res.validation, 'recommendations'))"></div>
               </div>
             </div>

             <!-- Section 7: Technical Accuracy Notes -->
             <div class="feedback-section technical-notes-section">
               <div class="feedback-header">
                 <span class="feedback-icon">{{getSectionIcon('technical-notes')}}</span>
                 <h3 class="feedback-title">7. Technical Accuracy Notes</h3>
               </div>
               <div class="section-content" [innerHTML]="processCodeBlocks(getStructuredFeedback(res.validation, 'technical_notes'))"></div>
             </div>
           </div>

           <!-- Enhanced Summary Table -->
           <div *ngIf="res.scoring_breakdown" class="summary-section">
             <h3 class="section-heading">📊 Assessment Summary</h3>
             <div class="table-container">
               <table class="enhanced-summary-table">
                 <thead>
                   <tr>
                     <th>Assessment Area</th>
                     <th>Score</th>
                     <th>Status</th>
                     <th>Progress</th>
                   </tr>
                 </thead>
                 <tbody>
                   <tr>
                     <td><span class="table-icon">{{getTableIcon(getStatusText(res.scoring_breakdown.correctness))}}</span>Correctness</td>
                     <td>{{res.scoring_breakdown.correctness || 'N/A'}}%</td>
                     <td><span class="status-badge" [ngClass]="getStatusBadgeClass(res.scoring_breakdown.correctness)">{{getStatusText(res.scoring_breakdown.correctness)}}</span></td>
                     <td class="progress-cell">
                       <div class="table-progress-bar">
                         <div class="table-progress-fill" [style.width.%]="res.scoring_breakdown.correctness" [style.background-color]="getProgressBarColor(res.scoring_breakdown.correctness)"></div>
                       </div>
                       <div class="score-text">{{res.scoring_breakdown.correctness || 0}}%</div>
                     </td>
                   </tr>
                   <tr>
                     <td><span class="table-icon">{{getTableIcon(getStatusText(res.scoring_breakdown.code_quality))}}</span>Code Quality</td>
                     <td>{{res.scoring_breakdown.code_quality || 'N/A'}}%</td>
                     <td><span class="status-badge" [ngClass]="getStatusBadgeClass(res.scoring_breakdown.code_quality)">{{getStatusText(res.scoring_breakdown.code_quality)}}</span></td>
                     <td class="progress-cell">
                       <div class="table-progress-bar">
                         <div class="table-progress-fill" [style.width.%]="res.scoring_breakdown.code_quality" [style.background-color]="getProgressBarColor(res.scoring_breakdown.code_quality)"></div>
                       </div>
                       <div class="score-text">{{res.scoring_breakdown.code_quality || 0}}%</div>
                     </td>
                   </tr>
                   <tr>
                     <td><span class="table-icon">{{getTableIcon(getStatusText(res.scoring_breakdown.completeness))}}</span>Completeness</td>
                     <td>{{res.scoring_breakdown.completeness || 'N/A'}}%</td>
                     <td><span class="status-badge" [ngClass]="getStatusBadgeClass(res.scoring_breakdown.completeness)">{{getStatusText(res.scoring_breakdown.completeness)}}</span></td>
                     <td class="progress-cell">
                       <div class="table-progress-bar">
                         <div class="table-progress-fill" [style.width.%]="res.scoring_breakdown.completeness" [style.background-color]="getProgressBarColor(res.scoring_breakdown.completeness)"></div>
                       </div>
                       <div class="score-text">{{res.scoring_breakdown.completeness || 0}}%</div>
                     </td>
                   </tr>
                   <tr>
                     <td><span class="table-icon">{{getTableIcon(getStatusText(res.scoring_breakdown.learning_application))}}</span>Learning Application</td>
                     <td>{{res.scoring_breakdown.learning_application || 'N/A'}}%</td>
                     <td><span class="status-badge" [ngClass]="getStatusBadgeClass(res.scoring_breakdown.learning_application)">{{getStatusText(res.scoring_breakdown.learning_application)}}</span></td>
                     <td class="progress-cell">
                       <div class="table-progress-bar">
                         <div class="table-progress-fill" [style.width.%]="res.scoring_breakdown.learning_application" [style.background-color]="getProgressBarColor(res.scoring_breakdown.learning_application)"></div>
                       </div>
                       <div class="score-text">{{res.scoring_breakdown.learning_application || 0}}%</div>
                     </td>
                   </tr>
                   <tr>
                     <td><span class="table-icon">{{getTableIcon(getStatusText(res.score))}}</span>Overall</td>
                     <td>{{res.score}}%</td>
                     <td><span class="status-badge" [ngClass]="getStatusBadgeClass(res.score)">{{getStatusText(res.score)}}</span></td>
                     <td class="progress-cell">
                       <div class="table-progress-bar">
                         <div class="table-progress-fill" [style.width.%]="res.score" [style.background-color]="getProgressBarColor(res.score)"></div>
                       </div>
                       <div class="score-text">{{res.score}}%</div>
                     </td>
                   </tr>
                 </tbody>
               </table>
             </div>
           </div>
         </div>
      </div>
    </div>
  </div>

  <!-- Footer Buttons -->
  <!-- <div class="mt-8 flex justify-center items-center space-x-4">
    <button class="px-6 py-2.5 bg-gradient-hero text-white font-semibold rounded-lg hover:shadow-glow hover:-translate-y-1 hover:scale-105 transition-all duration-200 transform" (click)="navigateToDashboard()">Back to Dashboard</button>
  </div> -->

  <!-- PDF Download Modal -->
  <app-pdf-download-modal
    [isOpen]="showPdfModal"
    [isGenerating]="isGeneratingPdf"
    (confirm)="confirmPdfDownload()"
    (cancel)="closePdfModal()">
  </app-pdf-download-modal>
</main>
